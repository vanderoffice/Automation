---
phase: 03-form-ui
plan: 03
type: execute
---

<objective>
Add ECOS access group selection, form validation, and form submission to complete the agreement form.

Purpose: This is the final plan for Phase 3 — it completes the form by adding access group checkboxes (the actual permissions being requested), wiring up validation across all fields, and submitting the agreement to Supabase. After this plan, the form is fully functional end-to-end.
Output: Complete, validated agreement form that persists to the database with access groups, ready for the signature workflow (Phase 4).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans in this phase:
@.planning/phases/03-form-ui/03-01-SUMMARY.md
@.planning/phases/03-form-ui/03-02-SUMMARY.md

# Prior phase summaries:
@.planning/phases/02-database-api/02-02-SUMMARY.md

# Key source files:
@src/components/form/AgreementForm.jsx
@src/components/ui/Checkbox.jsx
@src/components/ui/Alert.jsx
@src/components/ui/Button.jsx
@src/lib/api/agreements.js
@src/lib/api/index.js
@src/lib/supabase.js
@src/context/RoleContext.jsx
@sql/001-schema.sql

**Tech stack available:** React 18, Tailwind CSS 3, @supabase/supabase-js
**Established patterns:** data-error-return-pattern (Supabase API), barrel-export-api-modules
**Constraining decisions:**
- Phase 02-02: API uses { data, error } return pattern from Supabase
- Phase 02-03: Demo-permissive RLS — anon gets full access
- Schema: agreement_access_groups junction table with (agreement_id, group_name) unique constraint
- Schema: agreements.track CHECK IN ('new_updated', 'annual_renewal')
- Schema: agreements.status defaults to 'draft'
</context>

<tasks>

<task type="auto">
  <name>Task 1: Access group checkboxes and data</name>
  <files>src/data/accessGroups.js, src/components/form/AccessGroupSection.jsx, src/components/form/AgreementForm.jsx</files>
  <action>
  **src/data/accessGroups.js:** Create a data file exporting an array of ECOS access groups. Each group has: id (string key), name (display name), description (one-line), category ('standard' | 'elevated'). Define these groups representing realistic ECOS system access levels:

  Standard access:
  1. "ecos_user" — "ECOS User" — "Basic ECOS system access for viewing and entering personnel transactions"
  2. "personnel_transactions" — "Personnel Transactions" — "Create and submit personnel action requests (PAR)"
  3. "position_control" — "Position Control" — "View and manage position allocations and classifications"
  4. "exam_unit" — "Exam Unit" — "Access examination scheduling, scoring, and certification lists"
  5. "classification_unit" — "Classification & Pay" — "View and manage classification specifications and pay scales"

  Elevated access:
  6. "fiscal_reporting" — "Fiscal & Reporting" — "Access payroll data, fiscal reports, and budget allocations"
  7. "system_admin" — "System Administration" — "Administrative access including user management and configuration"
  8. "audit_compliance" — "Audit & Compliance" — "View audit trails, compliance reports, and security logs"

  **AccessGroupSection.jsx:** Create the access group selection component:
  - Props: selectedGroups (string[]), onChange handler, track ('new_updated' | 'annual_renewal')
  - Uses SectionHeader with title "ECOS Access Groups"
  - For new_updated track:
    - Render all groups organized by category (Standard Access, Elevated Access) in separate Cards
    - Each group as a Checkbox with the group name as label and description as the Checkbox description prop
    - Elevated access groups get a subtle orange-left-border Card to indicate higher privilege
    - When any elevated group is selected, show an Alert (variant="warning"): "Elevated access groups require additional administrator review"
  - For annual_renewal track:
    - Show a simplified view: "Your current access groups will be renewed" with a read-only list
    - For demo purposes, show 2-3 pre-checked groups as if they were the previous year's selections (hardcode for demo: ecos_user + personnel_transactions)
    - Allow adding/removing groups with a "Modify access groups" toggle that expands to the full checkbox list

  **AgreementForm.jsx update:**
  - Add selectedGroups to form state: string[] initialized to [] (or pre-populated for annual_renewal)
  - Add handleGroupToggle(groupId) that adds/removes from the array
  - Wire AccessGroupSection into the form between AcknowledgmentSection and the submit area
  - When any elevated group (system_admin, audit_compliance) is selected, set showAdminSection=true on SecurityContentSection and AcknowledgmentSection so the admin responsibilities section appears

  **Avoid:** Don't write groups to the database yet — submission is Task 2. Just manage checkbox state.
  </action>
  <verify>
  Navigate to /ecosform/agreement, select "New/Updated User" track:
  - Access groups section shows 5 standard + 3 elevated groups in categorized cards
  - Checkboxes toggle correctly
  - Selecting an elevated group shows warning Alert
  - Selecting system_admin or audit_compliance reveals the admin responsibilities section in security content

  Select "Annual Renewal" track:
  - Shows simplified view with pre-selected groups
  - "Modify access groups" toggle expands full list
  </verify>
  <done>Access groups render with categorized display, elevated access warnings, and conditional admin section visibility. Both tracks handle group selection correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Form validation and database submission</name>
  <files>src/lib/api/accessGroups.js, src/lib/api/index.js, src/components/form/FormActions.jsx, src/components/form/AgreementForm.jsx</files>
  <action>
  **src/lib/api/accessGroups.js:** Create API helper for access group operations:
  - saveAccessGroups(agreementId, groupNames[]) — inserts rows into agreement_access_groups for each selected group. Use supabase.from('agreement_access_groups').insert(rows). Return { data, error } pattern.
  - getAccessGroups(agreementId) — fetches access groups for an agreement. Return { data, error }.
  - Export both functions.

  **src/lib/api/index.js update:** Add re-exports for the new accessGroups module.

  **FormActions.jsx:** Create the form footer/action bar:
  - Props: onSubmit, onSaveDraft, isSubmitting (boolean), isValid (boolean), errors (object)
  - Render in a sticky bottom bar or a Card at the bottom:
    - "Save as Draft" Button (variant="secondary") — saves without validation
    - "Submit Agreement" Button (variant="primary") — validates then submits
    - When isSubmitting: disable both buttons, show loading text on active button
  - If errors exist, render an Alert (variant="error") above the buttons listing all validation errors as a bulleted list

  **AgreementForm.jsx — validation logic:**
  Add a validateForm() function that checks:
  - track must be selected (always true by this point since form doesn't show without track)
  - supervisorName is not empty
  - workPhone is not empty
  - workLocation is not empty
  - For new_updated track: at least one access group selected
  - All acknowledgment checkboxes checked (every section.id must be true in acknowledgments)
  - Return { isValid: boolean, errors: { [fieldName]: string } }

  Highlight fields with errors: pass error prop to TextInput components in DepartmentInfoSection. Add an errors prop to DepartmentInfoSection and wire it through.

  **AgreementForm.jsx — submission logic:**
  Add handleSubmit() that:
  1. Runs validateForm() — if invalid, set errors in state, scroll to first error, return
  2. Set isSubmitting = true
  3. Call createAgreement({ employee_id: currentEmployee.id, track, fiscal_year: formState.fiscalYear, supervisor_name, work_phone, work_location, form_version_hash: 'sha256_v1_demo_abc123', status: 'draft' })
  4. If error, show Alert with error message, set isSubmitting = false, return
  5. Call saveAccessGroups(agreement.id, selectedGroups)
  6. If error, show Alert with error message, set isSubmitting = false, return
  7. On success: show a success state — replace the form with a success Card showing:
     - Green checkmark icon
     - "Agreement Created Successfully"
     - Agreement details summary (track, employee, fiscal year, number of access groups)
     - "Your agreement has been saved as a draft. It will need to be submitted for signatures."
     - Two buttons: "Create Another" (resets form) and "View Workflow" (navigates to /ecosform/workflow)

  Add handleSaveDraft() — same as submit but skips validation (saves whatever state exists). Show a less prominent success message: "Draft saved" as a temporary toast-like Alert at the top.

  **Avoid:** Don't call submitForSignature() or advanceWorkflow() — that's Phase 4. The form creates draft agreements only. Don't implement real toast notifications — a temporary Alert that auto-dismisses after 3 seconds (setTimeout + state) is fine.
  </action>
  <verify>
  Test the full submission flow:
  1. Select track, fill department fields, open security sections, check all acknowledgments, select access groups
  2. Click "Submit Agreement" — should create record in database, show success state
  3. Test validation: leave supervisor empty, click submit — error shown on field, Alert lists errors
  4. Test "Save as Draft" with partial data — saves without validation errors
  5. Check Supabase: agreement record created with correct fields, access_groups junction records created
  6. "Create Another" resets form, "View Workflow" navigates correctly
  </verify>
  <done>Form validates all required fields, creates agreement + access groups in Supabase, shows success state with next-step navigation. Save as Draft works without validation. Error states display clearly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete ECOS agreement form with track selection, employee info, security content, access groups, validation, and database submission</what-built>
  <how-to-verify>
    1. Run: dev server on port 5180 (docker compose up or npm run dev)
    2. Visit: http://localhost:5180/ecosform/agreement
    3. Test New/Updated User track:
       a. Select "New / Updated User" — form sections appear
       b. Verify employee info auto-fills from current demo role
       c. Fill supervisor name, phone, location
       d. Expand security sections — read content
       e. Check all acknowledgment boxes (try Select All)
       f. Select 2-3 access groups including one elevated
       g. Verify admin responsibilities section appears when elevated group selected
       h. Click Submit — verify success state appears
    4. Test validation: start fresh, try to submit with empty fields — verify error messages
    5. Test Annual Renewal track: verify simplified access group view
    6. Switch demo roles — verify employee info updates
    7. Confirm: Professional appearance, readable security content, smooth form flow, no console errors
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Access groups render with categorized display (standard + elevated)
- [ ] Elevated access triggers admin section and warning
- [ ] All validation rules enforced (supervisor, phone, location, groups, acknowledgments)
- [ ] Error states display correctly on fields and as summary Alert
- [ ] createAgreement + saveAccessGroups write to database successfully
- [ ] Success state shows with correct details and navigation
- [ ] Save as Draft works without validation
- [ ] Annual Renewal track shows simplified group view
- [ ] No console errors or warnings
- [ ] Phase 3 complete — form is fully functional
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Agreement form creates database records end-to-end
- Form validation catches all required fields
- Both tracks (new_updated, annual_renewal) function correctly
- Phase 3: Form UI complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-form-ui/03-03-SUMMARY.md`
</output>
