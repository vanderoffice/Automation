---
phase: 04-signature-workflow
plan: 02
type: execute
---

<objective>
Wire the SignatureBlock into the agreement submission flow — when an employee submits a form, transition it to `pending_employee` and present the signature block for immediate signing.

Purpose: Connect the form submission to the signature workflow so agreements move through the Employee → Manager → Admin pipeline with real database writes.
Output: Complete employee signing flow — form submit creates draft, transitions to pending_employee, employee signs, agreement advances to pending_manager.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/02-database-api/02-02-SUMMARY.md
@.planning/phases/03-form-ui/03-03-SUMMARY.md
@.planning/phases/04-signature-workflow/04-01-SUMMARY.md

# Key source files:
@src/components/form/AgreementForm.jsx
@src/lib/api/workflow.js
@src/lib/api/signatures.js
@src/lib/api/audit.js
@src/lib/api/index.js
@src/components/form/SignatureBlock.jsx
@src/lib/auditMeta.js

**Tech stack available:** React 18, Supabase JS client, PostgREST API
**Established patterns:** two-step-db-write, curried-handleChange, data-error-return-pattern
**Constraining decisions:**
- Phase 02-02: persistSession: false — demo app, no real Supabase Auth
- Phase 02-03: Role filtering at API layer, not RLS
- Phase 03-03: Two-step DB write (agreement → groups) — extend to three-step (agreement → groups → submit for signature)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate signing into form submission flow</name>
  <files>src/components/form/AgreementForm.jsx</files>
  <action>Modify the AgreementForm success state to include the employee signature step:

  **Current flow:** Submit → create agreement (draft) → save access groups → show success card.
  **New flow:** Submit → create agreement (draft) → save access groups → call `submitForSignature(agreement.id)` to transition to `pending_employee` → show SignatureBlock for employee signing → on sign: call `createSignature(...)` + `advanceWorkflow(...)` + `logAction(...)` → show final success.

  Changes to `handleSubmit()`:
  1. After access groups saved, call `submitForSignature(agreement.id)` from workflow API
  2. Store the created agreement in `submitSuccess` state (already happens)
  3. Add new state: `signatureComplete` (boolean, starts false)

  Changes to success rendering:
  1. When `submitSuccess` is set but `signatureComplete` is false: show the agreement summary info PLUS a SignatureBlock in active state with `signerRole="employee"` and `signerName` from currentEmployee
  2. SignatureBlock's `onSign` handler should:
     a. Call `createSignature({ agreement_id, signer_id: currentEmployee.id, signer_role: 'employee', typed_name, certified, ip_address, user_agent, session_hash, form_version_hash })`
     b. Call `advanceWorkflow(agreement.id, { signer_role: 'employee' })` to move status to `pending_manager`
     c. Call `logAction(agreement.id, currentEmployee.id, 'signed', { role: 'employee', typed_name })` for audit trail
     d. Set `signatureComplete` to true
  3. When `signatureComplete` is true: show the existing success card with a note: "Submitted and signed. Awaiting manager approval." and the "View Workflow" button.

  Import SignatureBlock from './SignatureBlock' and getAuditMeta is called inside SignatureBlock already (no import needed here). Import `submitForSignature`, `advanceWorkflow` from API. Import `createSignature` from API. Import `logAction` from API.

  Handle errors at each step — if signature creation fails, show error alert but keep the agreement (it's already created).</action>
  <verify>Run dev server. Fill out agreement form, submit. Verify: agreement is created in Supabase `agreements` table with status `pending_employee`. SignatureBlock appears. Type name, check certification, click Sign. Verify: signature row appears in `signatures` table, agreement status advances to `pending_manager`, audit_log entry exists with action='signed'.</verify>
  <done>Employee can submit form and immediately sign — agreement transitions from draft → pending_employee → pending_manager in one flow. Signature, workflow transition, and audit log all persist to database.</done>
</task>

<task type="auto">
  <name>Task 2: Add API barrel exports for new workflow imports</name>
  <files>src/lib/api/index.js</files>
  <action>Ensure that `submitForSignature`, `advanceWorkflow`, `getWorkflowStatus`, `getPendingForRole` from workflow.js and `createSignature`, `getSignatures` from signatures.js and `logAction`, `getAuditLog` from audit.js are all exported from the barrel. Check what's already exported and add any missing. These will be needed by the WorkflowPage in the next plan.</action>
  <verify>Read src/lib/api/index.js and confirm all workflow, signature, and audit functions are exported.</verify>
  <done>All API helper functions accessible via `import { ... } from '../../lib/api'` barrel export.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Agreement form submit → creates agreement → transitions to pending_employee → shows SignatureBlock
- [ ] Employee signature creates signature row in DB
- [ ] Workflow advances agreement to pending_manager after employee signs
- [ ] Audit log entry created for signing action
- [ ] Error states handled gracefully (show alert, don't lose agreement)
- [ ] `npm run dev` starts without errors
</verification>

<success_criteria>

- Complete employee signing flow works end-to-end
- Database state correct after signing (agreement status, signature row, audit entry)
- API barrel exports complete for all workflow/signature/audit functions
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/04-signature-workflow/04-02-SUMMARY.md`
</output>
