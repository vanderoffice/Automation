---
phase: 02-database-api
plan: 02
type: execute
---

<objective>
Set up the Supabase JS client in the React frontend and create API helper modules for agreements, signatures, and workflow operations.

Purpose: Bridge the frontend to the database — provide clean, reusable data access functions that Phase 3 (Form UI), Phase 4 (Signature Workflow), and Phase 6 (Admin Dashboard) will consume.
Output: Supabase client configured with env vars, API helper modules with typed functions for all CRUD and workflow operations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-api/02-01-PLAN.md

# Phase 1 context
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

**Tech stack available:** React 18, Vite 5, Tailwind CSS 3, React Router v6
**Established patterns:** vanderdev-design-system, barrel-export, variant-props-pattern

**Key files:**
@src/App.jsx
@src/main.jsx
@vite.config.js
@docker-compose.yml

**Constraining decisions:**
- Phase 01-01: Port 5180 for dev server
- Phase 01-03: Minimal dependencies philosophy
- PROJECT.md: Supabase PostgREST backend

**Supabase connection details:**
- Kong API URL: http://212.38.95.33:8000 (or via Tailscale: http://100.111.63.3:8000)
- ANON_KEY: available in /root/n8n-cloud-stack/.env on VPS
- SERVICE_ROLE_KEY: available (for admin operations only)
- Schema: `ecos` (created in 02-01)
- PostgREST exposes ecos schema (configured in 02-01)

**Important:** The Supabase client needs to target the `ecos` schema, not `public`. Use the `db.schema()` option or set it in the client config.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Supabase JS client and configure environment</name>
  <files>src/lib/supabase.js, .env.example, .env.local, vite.config.js, docker-compose.yml</files>
  <action>
1. Install @supabase/supabase-js:
   ```
   cd /Users/slate/Documents/GitHub/Automation/ECOS && npm install @supabase/supabase-js
   ```

2. Create `.env.example` with placeholder values (committed to git):
   ```
   VITE_SUPABASE_URL=http://your-supabase-kong:8000
   VITE_SUPABASE_ANON_KEY=your-anon-key-here
   ```

3. Create `.env.local` with actual VPS values (gitignored — verify .gitignore has .env*):
   ```
   VITE_SUPABASE_URL=http://212.38.95.33:8000
   VITE_SUPABASE_ANON_KEY=<actual ANON_KEY from VPS>
   ```
   Get the actual key:
   ```
   ssh vps "grep ANON_KEY /root/n8n-cloud-stack/.env"
   ```

4. Create `src/lib/supabase.js`:
   ```javascript
   import { createClient } from '@supabase/supabase-js'

   const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
   const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

   if (!supabaseUrl || !supabaseAnonKey) {
     throw new Error('Missing Supabase environment variables. Copy .env.example to .env.local and fill in values.')
   }

   export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
     db: { schema: 'ecos' },
     auth: { persistSession: false },
   })
   ```

   Note: `persistSession: false` because this is a demo app with simulated auth, not real Supabase Auth.

5. Update `docker-compose.yml` dev service to pass env vars:
   ```yaml
   environment:
     - NODE_ENV=development
   env_file:
     - .env.local
   ```

6. Verify .gitignore includes `.env.local` and `.env*.local` patterns (should already have `.env*` from Phase 1).
  </action>
  <verify>
Start dev server and check browser console for no Supabase errors:
```
cd /Users/slate/Documents/GitHub/Automation/ECOS && npm run dev
```
Open http://localhost:5180/ecosform/ — no console errors about missing env vars.

Test Supabase connection from browser console (or create a temporary test):
```javascript
import { supabase } from './lib/supabase'
const { data, error } = await supabase.from('departments').select('*')
console.log(data, error)
```
Should return empty array (no data yet) with no error.
  </verify>
  <done>Supabase JS client installed, configured for `ecos` schema, env vars set up with .env.example template and .env.local with real values. Dev server starts without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create API helper modules</name>
  <files>src/lib/api/agreements.js, src/lib/api/employees.js, src/lib/api/signatures.js, src/lib/api/workflow.js, src/lib/api/audit.js, src/lib/api/index.js</files>
  <action>
Create data access modules in `src/lib/api/` that wrap Supabase calls. These provide clean interfaces for components to use without knowing Supabase query syntax.

1. `src/lib/api/employees.js`:
   - `getEmployees()` — all employees with department join
   - `getEmployeesByDepartment(departmentId)` — filtered
   - `getEmployeesByRole(role)` — filter by employee/manager/admin
   - `getEmployee(id)` — single employee with department

2. `src/lib/api/agreements.js`:
   - `getAgreements(filters)` — list with employee/department joins, optional status/department/employee filters
   - `getAgreement(id)` — single agreement with employee, department, access_groups, signatures
   - `createAgreement(data)` — insert new agreement, return created record
   - `updateAgreement(id, data)` — update agreement fields
   - `getAgreementsByStatus(status)` — filter by workflow status
   - `getAgreementsByEmployee(employeeId)` — employee's agreements
   - `getExpiringAgreements(daysUntilExpiry)` — agreements expiring within N days

3. `src/lib/api/signatures.js`:
   - `getSignatures(agreementId)` — all signatures for an agreement
   - `createSignature(data)` — record a signature (typed_name, certified, signer_role, audit metadata)
   - `getSignaturesByEmployee(employeeId)` — all signatures by a person

4. `src/lib/api/workflow.js`:
   - `submitForSignature(agreementId)` — transition draft → pending_employee
   - `advanceWorkflow(agreementId, signature)` — after signature, advance to next status
     - employee signs → pending_manager
     - manager signs → pending_admin
     - admin signs → completed, set completed_at
   - `getWorkflowStatus(agreementId)` — current status with who needs to sign next
   - `getPendingForRole(role)` — agreements waiting for this role's signature

5. `src/lib/api/audit.js`:
   - `logAction(agreementId, actorId, action, details)` — insert audit entry
   - `getAuditLog(agreementId)` — all audit entries for an agreement, ordered by created_at DESC
   - `getAuditLogByActor(actorId)` — all actions by an actor
   - `getRecentActivity(limit)` — most recent N audit entries across all agreements

6. `src/lib/api/index.js` — barrel export of all modules

Each function should:
- Use the shared supabase client from `src/lib/supabase.js`
- Return `{ data, error }` pattern (pass through Supabase's response)
- Use `.select()` with explicit column lists (not `*` in production patterns, but `*` is fine for this demo)
- Include appropriate `.order()` for list queries
- Log errors to console in development

Do NOT add authentication logic — that's simulated via role context in Plan 02-03.
Do NOT add React hooks or state management — components will call these directly.
  </action>
  <verify>
Verify all files exist and have correct exports:
```
ls src/lib/api/
```
Should show: agreements.js, employees.js, signatures.js, workflow.js, audit.js, index.js

Verify imports resolve:
```
cd /Users/slate/Documents/GitHub/Automation/ECOS && npm run build
```
Build should succeed with no import errors.

Verify barrel export works by checking index.js exports all modules.
  </verify>
  <done>6 API helper modules created with clean interfaces. All functions follow `{ data, error }` return pattern. Barrel export provides single import point. Build succeeds.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Supabase client connects to VPS (no auth errors with ANON_KEY)
- [ ] All 6 API modules have correct function signatures
- [ ] .env.example committed, .env.local gitignored
- [ ] No hardcoded credentials in source files
</verification>

<success_criteria>
- @supabase/supabase-js installed and configured for ecos schema
- Environment variables properly separated (.env.example vs .env.local)
- 5 API helper modules cover all CRUD and workflow operations
- Barrel export provides clean import interface
- Build passes, dev server runs without errors
- No credentials committed to git
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-api/02-02-SUMMARY.md`
</output>
