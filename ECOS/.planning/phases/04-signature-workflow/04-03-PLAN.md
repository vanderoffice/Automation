---
phase: 04-signature-workflow
plan: 03
type: execute
---

<objective>
Build the WorkflowPage showing agreements by status, a signature timeline for each agreement, and role-aware pending actions (manager/admin can sign pending agreements).

Purpose: Provide the workflow tracking view where managers and admins can see and act on pending agreements, completing the three-party signing chain.
Output: Working WorkflowPage with agreement list, signature timeline, and manager/admin signing capability. Full Employee → Manager → Admin workflow functional.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/02-database-api/02-03-SUMMARY.md
@.planning/phases/04-signature-workflow/04-01-SUMMARY.md
@.planning/phases/04-signature-workflow/04-02-SUMMARY.md

# Key source files:
@src/pages/WorkflowPage.jsx
@src/components/form/SignatureBlock.jsx
@src/lib/api/workflow.js
@src/lib/api/signatures.js
@src/lib/api/audit.js
@src/lib/api/agreements.js
@src/lib/api/index.js
@src/context/RoleContext.jsx
@src/components/ui/index.js

**Tech stack available:** React 18, Supabase JS, react-router-dom 6, Tailwind CSS 3
**Established patterns:** role-based-filtering, react-context-provider, data-error-return-pattern, barrel-export-api-modules
**Constraining decisions:**
- Phase 02-03: Role filtering at API layer via getAgreementsForRole
- Phase 02-03: localStorage for selected employee ID persistence
- Phase 01-02: Layout route with Outlet pattern — WorkflowPage renders inside Layout
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build WorkflowPage with agreement list and signature timeline</name>
  <files>src/pages/WorkflowPage.jsx</files>
  <action>Replace the placeholder WorkflowPage with a full workflow tracking view:

  **Data loading:**
  - Use `useRole()` to get `currentEmployee` and `role`
  - On mount (and when currentEmployee changes), fetch agreements relevant to current role:
    - Employee role: fetch agreements where `employee_id === currentEmployee.id` (use supabase query or a new helper)
    - Manager/Admin role: fetch agreements pending their signature via `getPendingForRole(role)` PLUS their own agreements
  - For each agreement, fetch its signatures via `getSignatures(agreement.id)`

  **Layout:**
  - Page header: "Workflow Status" with subtitle showing current role perspective
  - If no agreements: empty state card with message
  - Agreement cards in a vertical stack, each showing:
    1. **Header row:** Employee name, department, fiscal year, track badge (New/Updated or Annual Renewal)
    2. **Status badge:** Use Badge component. Draft=neutral, pending_employee=yellow, pending_manager=yellow, pending_admin=yellow, completed=green
    3. **Signature timeline:** Vertical timeline with three steps (Employee → Manager → Admin):
       - Each step shows: role label, signer name (if signed), timestamp (if signed), or "Pending" / "Awaiting"
       - Signed steps: green dot + checkmark, name + relative timestamp
       - Current step (pending): orange dot, pulsing, "Awaiting signature"
       - Future steps: gray dot, muted text
    4. **Action area:** If this agreement is pending the current role's signature, show a SignatureBlock (active). Otherwise show nothing or "Waiting for [role]".

  **Manager/Admin signing:**
  - When a manager/admin signs via SignatureBlock's onSign:
    a. `createSignature(...)` with appropriate signer_role
    b. `advanceWorkflow(agreement.id, { signer_role })`
    c. `logAction(agreement.id, currentEmployee.id, 'signed', { role, typed_name })`
    d. Refresh the agreement list to show updated state

  **Styling:**
  - Dark theme cards matching existing Card component patterns
  - Timeline uses `border-l-2` vertical line with positioned dots
  - Signed timestamps in `font-mono text-xs text-neutral-500`
  - Use relative time display (e.g., "2 minutes ago", "Today at 3:45 PM") — simple helper function, no library needed. Use `Intl.RelativeTimeFormat` or a small inline helper.

  Keep the component self-contained. If it gets too large, extract the timeline into a `SignatureTimeline` component in the same file (not a separate file — avoid file bloat for one-off helpers).</action>
  <verify>Run dev server. Switch to an employee role that has submitted agreements. Navigate to /ecosform/workflow. Verify: agreements display with correct status badges, signature timeline shows signed/pending/future states correctly. Switch to manager role. Verify: pending agreements for manager appear. Sign one — status advances to pending_admin. Switch to admin role. Sign — status advances to completed with green badge.</verify>
  <done>WorkflowPage shows role-aware agreement list with signature timeline. Manager and admin can sign pending agreements. Full three-party workflow (Employee → Manager → Admin) completes end-to-end.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete three-party signature workflow — Employee fills form and signs, Manager reviews and signs, Admin reviews and signs. Full audit trail in database.</what-built>
  <how-to-verify>
    1. Run: `npm run dev` (or docker compose up if using Docker)
    2. Visit: http://localhost:5180/ecosform/agreement
    3. Switch to an employee role (use role selector or default)
    4. Fill out agreement form (select track, fill department info, acknowledge sections, select access groups)
    5. Submit — verify SignatureBlock appears for employee
    6. Sign as employee — verify success message shows "Awaiting manager approval"
    7. Navigate to Workflow page — verify agreement shows with employee signature complete
    8. Switch to a manager role
    9. On Workflow page — verify the agreement appears as pending manager signature
    10. Sign as manager — verify agreement advances to pending_admin
    11. Switch to an admin role
    12. On Workflow page — verify the agreement appears as pending admin signature
    13. Sign as admin — verify agreement shows as Completed with green badge
    14. Check signature timeline shows all three signatures with timestamps
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] WorkflowPage shows agreements filtered by current role
- [ ] Signature timeline renders correctly for all states
- [ ] Manager can sign pending_manager agreements
- [ ] Admin can sign pending_admin agreements
- [ ] Completed agreements show all three signatures with timestamps
- [ ] `npm run dev` starts without errors
- [ ] No console warnings or errors during workflow
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Full three-party signature workflow works end-to-end
- Audit trail entries exist for every signature action
- Phase 4: Signature Workflow complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-signature-workflow/04-03-SUMMARY.md`
</output>
