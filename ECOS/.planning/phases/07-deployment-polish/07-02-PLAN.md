---
phase: 07-deployment-polish
plan: 02
type: execute
---

<objective>
Deploy the ECOS form to the VPS at vanderdev.net/ecosform with nginx-proxy auto-discovery and SSL.

Purpose: Get the demo live and accessible at vanderdev.net/ecosform so executives can view it.
Output: Running production container on VPS, accessible via HTTPS at vanderdev.net/ecosform.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-deployment-polish/07-01-SUMMARY.md

@docker-compose.prod.yml
@Dockerfile
@nginx.conf
@.env.production.example

**Infrastructure context (from ~/dotfiles/docs/INFRASTRUCTURE.md):**
- VPS: root@212.38.95.33 (ssh vps)
- nginx-proxy container already running, handles SSL via nginx-proxy-acme
- vanderdev-website already deployed at vanderdev.net (root path)
- Supabase stack running on VPS (supabase-kong, supabase-db, supabase-rest)
- VPS Supabase Kong API gateway accessible internally via Docker network
- Repo: vanderoffice/Automation on GitHub

**Constraining decisions:**
- Phase 02-01: ecos schema in VPS Supabase PostgreSQL
- Phase 02-02: Supabase client needs VITE_SUPABASE_URL pointing to VPS Kong (port 8443 or internal)
- Phase 02-03: Demo-permissive RLS policies (anon access)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push code and deploy container on VPS</name>
  <files>Remote VPS files</files>
  <action>
SSH into VPS and deploy:

1. Clone/pull the Automation repo on VPS:
   ```bash
   ssh vps "cd /root && git clone https://github.com/vanderoffice/Automation.git 2>/dev/null || (cd /root/Automation && git pull)"
   ```

2. Create .env.production on VPS with correct Supabase credentials:
   - VITE_SUPABASE_URL: The VPS Supabase Kong endpoint. Check how vanderdev-website or other apps connect to Supabase on VPS. Likely `http://supabase-kong:8000` (internal Docker network) or `https://212.38.95.33:8443` (external). Since the Supabase client runs in the BROWSER (not server-side), it needs a publicly accessible URL. Use the Kong external endpoint.
   - VITE_SUPABASE_ANON_KEY: Get from VPS Supabase `.env` file (look in /root/supabase/ or similar for ANON_KEY).

   IMPORTANT: Since Supabase JS runs client-side in the browser, the URL must be reachable from the user's browser, not just from within Docker. Find the public-facing Supabase URL on the VPS.

3. Ensure the nginx-proxy network exists:
   ```bash
   ssh vps "docker network ls | grep nginx-proxy || docker network create nginx-proxy"
   ```

4. Build and start the container:
   ```bash
   ssh vps "cd /root/Automation/ECOS && docker compose -f docker-compose.prod.yml up -d --build"
   ```

5. Verify container is running:
   ```bash
   ssh vps "docker ps | grep ecos"
   ```

6. Check nginx-proxy picked up the new container:
   ```bash
   ssh vps "docker logs nginx-proxy 2>&1 | tail -20"
   ```
  </action>
  <verify>
`ssh vps "docker ps | grep ecos"` shows container running and healthy.
`ssh vps "docker logs nginx-proxy 2>&1 | grep ecosform"` shows nginx-proxy detected the VIRTUAL_PATH.
  </verify>
  <done>
ECOS container running on VPS, nginx-proxy aware of /ecosform route.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Supabase connectivity and run migrations</name>
  <files>sql/001-schema.sql, sql/002-workflow.sql, sql/003-rls-policies.sql, sql/004-seed-data.sql, sql/005-expanded-seed.sql</files>
  <action>
Ensure the ecos schema and seed data exist on VPS Supabase:

1. Check if ecos schema already exists on VPS:
   ```bash
   ssh vps "docker exec supabase-db psql -U postgres -c \"SELECT schema_name FROM information_schema.schemata WHERE schema_name = 'ecos';\""
   ```

2. If schema doesn't exist, run all migrations in order:
   ```bash
   ssh vps "cat /root/Automation/ECOS/sql/001-schema.sql | docker exec -i supabase-db psql -U postgres"
   ssh vps "cat /root/Automation/ECOS/sql/002-workflow.sql | docker exec -i supabase-db psql -U postgres"
   ssh vps "cat /root/Automation/ECOS/sql/003-rls-policies.sql | docker exec -i supabase-db psql -U postgres"
   ssh vps "cat /root/Automation/ECOS/sql/004-seed-data.sql | docker exec -i supabase-db psql -U postgres"
   ssh vps "cat /root/Automation/ECOS/sql/005-expanded-seed.sql | docker exec -i supabase-db psql -U postgres"
   ```

3. Verify PostgREST exposes ecos schema:
   ```bash
   ssh vps "docker exec supabase-rest env | grep PGRST_DB_SCHEMAS"
   ```
   If ecos is not in the schemas list, add it and restart supabase-rest.

4. Test API access from the container's perspective:
   ```bash
   ssh vps "curl -s http://supabase-kong:8000/rest/v1/employees?select=id,first_name -H 'apikey: ANON_KEY' -H 'Authorization: Bearer ANON_KEY' | head -c 500"
   ```
   (Replace ANON_KEY with actual key from step 1 of Task 1)
  </action>
  <verify>
Schema exists: `ssh vps "docker exec supabase-db psql -U postgres -c \"SELECT count(*) FROM ecos.employees;\""` returns row count > 0.
PostgREST serves ecos: curl to Kong returns employee data.
  </verify>
  <done>
VPS Supabase has ecos schema with seed data. PostgREST exposes it. Browser-accessible Supabase URL confirmed working.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>ECOS form deployed at vanderdev.net/ecosform</what-built>
  <how-to-verify>
    1. Visit: https://vanderdev.net/ecosform/
    2. Confirm: Page loads with dark theme, ECOS form interface visible
    3. Test: Switch roles using sidebar role switcher
    4. Test: Navigate to Workflow page — agreements should load from VPS Supabase
    5. Test: Navigate to Dashboard page — compliance stats should appear
    6. Test: Create a new agreement — should persist to database
    7. Confirm: No console errors (open browser DevTools → Console)
    8. Confirm: SSL certificate valid (green lock in browser)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Container running on VPS (`docker ps` shows ecos-form)
- [ ] https://vanderdev.net/ecosform/ loads correctly
- [ ] Supabase data loads (role switching shows agreements)
- [ ] SSL working (no certificate warnings)
- [ ] No console errors in browser
</verification>

<success_criteria>

- All tasks completed
- ECOS form live at vanderdev.net/ecosform
- Data persists to VPS Supabase
- Human verification passed
- Ready for responsive polish (07-03)
</success_criteria>

<output>
After completion, create `.planning/phases/07-deployment-polish/07-02-SUMMARY.md`
</output>
