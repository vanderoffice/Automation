---
phase: 04-signature-workflow
plan: 01
type: execute
---

<objective>
Build the reusable SignatureBlock component with typed-name signature input, "I certify" checkbox, and audit metadata capture.

Purpose: Create the core signature UI that captures legally sufficient e-signatures (UETA/SAM 1734) with full audit metadata — reused by employee, manager, and admin signing flows.
Output: SignatureBlock component ready for integration, plus a utility for collecting audit metadata (IP, user agent, session hash, form version hash).
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency graph):
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/03-form-ui/03-01-SUMMARY.md

# Key source files:
@src/components/ui/index.js
@src/components/ui/TextInput.jsx
@src/components/ui/Checkbox.jsx
@src/components/ui/Card.jsx
@src/components/ui/Button.jsx
@sql/002-workflow.sql

**Tech stack available:** React 18, Tailwind CSS 3, vanderdev.net design tokens
**Established patterns:** atomic-component-library, variant-props-pattern, forwardRef-form-inputs, curried-handleChange
**Constraining decisions:**
- Phase 01-03: No clsx/twMerge — plain string concatenation for className logic
- Phase 01-03: Component patterns use forwardRef for form inputs
- Phase 03-01: Form components live in src/components/form/ directory
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit metadata utility</name>
  <files>src/lib/auditMeta.js</files>
  <action>Create a utility module that collects signature audit metadata:
  - `getAuditMeta()` returns `{ ip_address, user_agent, session_hash, form_version_hash }`
  - `user_agent`: Use `navigator.userAgent`
  - `session_hash`: Generate a SHA-256 hash of `sessionStorage` session ID. If no session ID exists, create one with `crypto.randomUUID()` and store it in `sessionStorage` under key `ecos_session_id`. Hash using `crypto.subtle.digest('SHA-256', ...)` and convert to hex string.
  - `form_version_hash`: Accept as parameter (caller provides it). Default to `'sha256_v1_demo_abc123'` for demo.
  - `ip_address`: Set to `null` — client can't reliably self-report IP. The field exists in the schema for server-side population. Add a comment explaining this.
  - Export as async function (crypto.subtle.digest is async).
  - No external dependencies — use Web Crypto API only.</action>
  <verify>Import the module in browser console or a test: `const meta = await getAuditMeta(); console.log(meta)` should return object with all four fields, session_hash should be a 64-char hex string, user_agent should be populated.</verify>
  <done>Module exports `getAuditMeta(formVersionHash?)` that returns `{ ip_address: null, user_agent: string, session_hash: string, form_version_hash: string }`</done>
</task>

<task type="auto">
  <name>Task 2: Build SignatureBlock component</name>
  <files>src/components/form/SignatureBlock.jsx</files>
  <action>Create a self-contained signature block component used by all three signer roles:

  **Props:**
  - `signerRole` — 'employee' | 'manager' | 'admin' (controls header text)
  - `signerName` — pre-filled display name of the signer (from currentEmployee)
  - `onSign(signatureData)` — callback when signature is submitted; receives `{ typed_name, certified, ...auditMeta }`
  - `disabled` — boolean, grays out the block (not this signer's turn)
  - `existingSignature` — if already signed, show read-only signed state

  **Layout (matches vanderdev.net dark theme):**
  - Card wrapper with subtle border. Header: role-specific title ("Employee Signature", "Manager Approval", "Department Admin Approval").
  - If `existingSignature` provided: show green checkmark, typed name, signed timestamp in `font-mono text-sm`. No inputs.
  - If `disabled`: show muted "Awaiting [previous role] signature" message. No inputs.
  - If active (not disabled, no existing signature):
    1. TextInput for typed name, pre-filled with `signerName`, label "Type your full legal name to sign"
    2. Checkbox: "I certify that I have read, understand, and agree to comply with the terms of this ECOS Security Agreement."
    3. Button "Sign Agreement" (primary variant, orange) — disabled until both typed_name is non-empty AND certified is checked.
    4. Below button: small muted text: "By signing, you agree under UETA (Civil Code 1633.7) that your typed name constitutes a valid electronic signature."

  **On sign click:**
  - Call `getAuditMeta()` to collect metadata
  - Call `onSign({ typed_name, certified: true, ...auditMeta })`
  - Show brief loading state on button during callback

  Use existing TextInput, Checkbox, Button, Card components from ui/. Follow the same className string concatenation pattern (no clsx). Do NOT use forwardRef on this component — it's a composite, not a primitive input.</action>
  <verify>Import SignatureBlock in a test page. Render with `signerRole="employee"` and `signerName="Test User"`. Verify: TextInput shows pre-filled name, checkbox is unchecked, button is disabled. Check the checkbox — button enables. Click sign — onSign callback fires with typed_name + certified + audit metadata fields.</verify>
  <done>SignatureBlock renders three states (active/disabled/signed), captures typed-name + certification + audit metadata, and calls onSign callback on submission.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `getAuditMeta()` returns all four fields with correct types
- [ ] `session_hash` is consistent within a browser session (same sessionStorage ID)
- [ ] SignatureBlock renders correctly in active, disabled, and signed states
- [ ] Sign button only enables when both typed_name and certified are truthy
- [ ] `npm run dev` starts without errors
</verification>

<success_criteria>

- Both files created and exported
- SignatureBlock handles all three visual states
- Audit metadata utility uses Web Crypto API (no external deps)
- No TypeScript/lint errors introduced
- Components follow existing design system patterns
</success_criteria>

<output>
After completion, create `.planning/phases/04-signature-workflow/04-01-SUMMARY.md`
</output>
